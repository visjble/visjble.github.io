<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobile PDF Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            height: 100dvh; /* Use dynamic viewport height for mobile */
            overflow: hidden;
            width: 100%;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        /* Header & Menu */
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 50;
            height: 50px;
        }

        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            margin-right: 15px;
            line-height: 1;
            padding: 5px;
        }
        
        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            flex: 1;
        }
        
        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .side-menu-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 260px;
            max-width: 85%;
            height: 100%;
            background: white;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }
        
        .side-menu.open {
            transform: translateX(300px);
        }
        
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .menu-header h2 {
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .close-menu {
            font-size: 22px;
            background: none;
            border: none;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
        }
        
        .menu-section {
            margin-bottom: 15px;
        }
        
        .menu-section.expand {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 0;
        }
        
        .menu-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #95a5a6;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* File Input */
        .file-label {
            display: block;
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .file-label:active {
            background-color: #2980b9;
        }
        
        /* Search */
        .search-container {
            display: flex;
            gap: 5px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px; /* Prevents iOS zoom */
        }
        
        .search-btn {
            padding: 0 12px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* PDF Container */
        .pdf-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background-color: #ecf0f1;
            display: flex;
            justify-content: center;
        }
        
        .pdf-content {
            padding: 20px 40px; /* Extra side padding for navigation clearance */
            width: 100%;
            max-width: 900px;
            background: white;
            min-height: 100%;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .text-layer {
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
            color: #333;
        }
        
        .text-layer p {
            margin-bottom: 1em;
        }
        
        .highlight {
            background-color: #f1c40f;
            color: black;
            border-radius: 2px;
            padding: 0 2px;
        }
        
        /* Loading */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 20;
            text-align: center;
        }
        
        /* Navigation Overlays */
        .nav-overlay {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            font-size: 40px;
            opacity: 0.15;
            cursor: pointer;
            z-index: 40;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.2s, background 0.2s;
            border-radius: 12px;
        }
        
        .nav-overlay:active {
            background-color: rgba(0,0,0,0.1);
            opacity: 0.5;
        }
        
        .nav-prev {
            left: 10px;
        }
        
        .nav-next {
            right: 10px;
        }
        
        .nav-overlay.disabled {
            display: none;
        }
        
        /* Page Info Overlay */
        .page-info-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(44, 62, 80, 0.8);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            pointer-events: none;
            z-index: 30;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: fixed;
            right: 20px;
            bottom: 70px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 40;
        }
        
        .zoom-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        
        .zoom-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="menu-btn" id="menu-btn">‚ò∞</div>
            <h1>PDF Reader</h1>
        </div>

        <!-- Side Menu -->
        <div class="side-menu-overlay" id="menu-overlay"></div>
        <div class="side-menu" id="side-menu">
            <div class="menu-header">
                <h2>Menu</h2>
                <button class="close-menu" id="close-menu">√ó</button>
            </div>
            
            <div class="menu-section">
                <h3>Document</h3>
                <label for="file-input" class="file-label" style="padding: 8px; font-size: 13px;">
                    Open PDF File
                    <input type="file" id="file-input" accept=".pdf" style="display: none;">
                </label>
            </div>
            
            <div class="menu-section">
                <h3>Bookmarks</h3>
                <div id="bookmarks-list" style="margin-top: 5px; max-height: 150px; overflow-y: auto; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <div style="font-size: 12px; color: #95a5a6; font-style: italic;">No bookmarks yet</div>
                </div>
            </div>
            
            <div class="menu-section expand">
                <h3>Search</h3>
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Find text...">
                    <button id="search-btn" class="search-btn">üîç</button>
                </div>
                <div id="search-status" style="margin-top: 5px; font-size: 12px; color: #7f8c8d;"></div>
                <div id="search-results" style="margin-top: 10px; flex: 1; overflow-y: auto;"></div>
            </div>

            <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; font-size: 10px; color: #95a5a6; text-align: center;">
                ¬© Visjble | No License
            </div>
        </div>

        <!-- Main Content -->
        <div class="pdf-container" id="pdf-container">
            <div class="loading-indicator" id="loading-indicator" style="display: none;">
                Loading...
            </div>
            <div class="pdf-content" id="pdf-content">
                <div class="text-layer" id="text-layer">
                    <div style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        Tap the menu ‚ò∞ to open a PDF
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Overlays -->
        <div class="nav-overlay nav-prev" id="nav-prev">‚ùÆ</div>
        <div class="nav-overlay nav-next" id="nav-next">‚ùØ</div>
        
        <!-- Info Overlay -->
        <div class="page-info-overlay" id="page-info-container" style="display: none; display: flex; align-items: center; gap: 10px; pointer-events: auto;">
            <span id="page-info">Page 0 of 0</span>
            <button id="add-bookmark-btn" style="background:none; border:none; color:white; cursor:pointer; font-size:16px; padding: 2px 5px; border-left: 1px solid rgba(255,255,255,0.3);">üîñ</button>
        </div>
        
        <!-- Zoom -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-in">+</button>
            <button class="zoom-btn" id="zoom-out">‚àí</button>
        </div>
    </div>

    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // State
        let pdfDoc = null;
        let currentPage = 1;
        let fontScale = 1.0;
        const MIN_FONT_SCALE = 0.5;
        const MAX_FONT_SCALE = 3.0;
        let currentSearchQuery = '';
        let currentFileName = '';
        let bookmarks = [];
        
        // DOM Elements
        const pdfContainer = document.getElementById('pdf-container');
        const textLayer = document.getElementById('text-layer');
        const loadingIndicator = document.getElementById('loading-indicator');
        const pageInfoContainer = document.getElementById('page-info-container');
        const pageInfo = document.getElementById('page-info');
        const navPrev = document.getElementById('nav-prev');
        const navNext = document.getElementById('nav-next');
        const searchStatus = document.getElementById('search-status');
        const searchResults = document.getElementById('search-results');
        const bookmarksList = document.getElementById('bookmarks-list');
        const addBookmarkBtn = document.getElementById('add-bookmark-btn');
        
        // Menu Elements
        const menuBtn = document.getElementById('menu-btn');
        const closeMenuBtn = document.getElementById('close-menu');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        
        // Global Functions (accessible everywhere)
        function toggleMenu(show) {
            if (show) {
                sideMenu.classList.add('open');
                menuOverlay.classList.add('open');
            } else {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Menu listeners
            menuBtn.addEventListener('click', () => toggleMenu(true));
            closeMenuBtn.addEventListener('click', () => toggleMenu(false));
            menuOverlay.addEventListener('click', () => toggleMenu(false));
            
            // File input
            document.getElementById('file-input').addEventListener('change', (e) => {
                handleFileSelect(e);
                toggleMenu(false);
            });
            
            // Search
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            // Navigation
            navPrev.addEventListener('click', prevPage);
            navNext.addEventListener('click', nextPage);
            
            // Zoom
            document.getElementById('zoom-in').addEventListener('click', () => adjustFontSize(0.1));
            document.getElementById('zoom-out').addEventListener('click', () => adjustFontSize(-0.1));
            
            // Pinch Zoom
            setupPinchZoom();

            // Bookmark
            addBookmarkBtn.addEventListener('click', toggleBookmark);
            
            // Initial UI state
            updateNavState();
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please select a valid PDF file.');
                return;
            }
            
            currentFileName = file.name;
            loadingIndicator.style.display = 'block';
            textLayer.innerHTML = '';
            pageInfoContainer.style.display = 'none';
            searchResults.innerHTML = ''; // Clear search results
            searchStatus.textContent = '';
            
            // Load bookmarks for this file
            loadBookmarks();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const typedArray = new Uint8Array(e.target.result);
                loadPdf(typedArray);
            };
            reader.readAsArrayBuffer(file);
        }
        
        function loadBookmarks() {
            const saved = localStorage.getItem(`bookmarks_${currentFileName}`);
            bookmarks = saved ? JSON.parse(saved) : [];
            renderBookmarksList();
            updateBookmarkButton();
        }

        function saveBookmarks() {
            localStorage.setItem(`bookmarks_${currentFileName}`, JSON.stringify(bookmarks));
            renderBookmarksList();
            updateBookmarkButton();
        }

        function toggleBookmark() {
            if (!pdfDoc) return;
            const index = bookmarks.indexOf(currentPage);
            if (index === -1) {
                bookmarks.push(currentPage);
                bookmarks.sort((a, b) => a - b);
            } else {
                bookmarks.splice(index, 1);
            }
            saveBookmarks();
        }

        function updateBookmarkButton() {
            if (bookmarks.includes(currentPage)) {
                addBookmarkBtn.style.color = '#f1c40f'; // Gold for active
                addBookmarkBtn.textContent = 'üîñ';
            } else {
                addBookmarkBtn.style.color = 'white';
                addBookmarkBtn.textContent = 'üîñ';
            }
        }

        function renderBookmarksList() {
            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<div style="font-size: 12px; color: #95a5a6; font-style: italic;">No bookmarks yet</div>';
                return;
            }

            bookmarks.forEach(pageNum => {
                const item = document.createElement('div');
                item.style.padding = '4px 8px';
                item.style.borderBottom = '1px solid #eee';
                item.style.cursor = 'pointer';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                item.style.fontSize = '13px';
                
                const label = document.createElement('span');
                label.textContent = `Page ${pageNum}`;
                label.onclick = () => {
                    currentPage = pageNum;
                    renderPage(currentPage);
                    toggleMenu(false);
                };
                
                const remove = document.createElement('button');
                remove.textContent = '√ó';
                remove.style.background = 'none';
                remove.style.border = 'none';
                remove.style.color = '#e74c3c';
                remove.style.fontSize = '18px';
                remove.style.cursor = 'pointer';
                remove.style.padding = '0 5px';
                remove.onclick = (e) => {
                    e.stopPropagation();
                    bookmarks = bookmarks.filter(p => p !== pageNum);
                    saveBookmarks();
                };

                item.appendChild(label);
                item.appendChild(remove);
                bookmarksList.appendChild(item);
            });
        }
        
        function loadPdf(data) {
            pdfjsLib.getDocument(data).promise
                .then(pdf => {
                    pdfDoc = pdf;
                    currentPage = 1;
                    renderPage(currentPage);
                })
                .catch(err => {
                    console.error(err);
                    loadingIndicator.style.display = 'none';
                    textLayer.innerHTML = `<p style="color:red">Error loading PDF: ${err.message}</p>`;
                });
        }
        
        async function renderPage(num) {
            loadingIndicator.style.display = 'block';
            
            try {
                const page = await pdfDoc.getPage(num);
                const textContent = await page.getTextContent();
                
                // Clear content
                textLayer.innerHTML = '';
                
                // Group text items into paragraphs roughly
                let currentP = null;
                let lastY = null;
                
                textContent.items.forEach(item => {
                    if (lastY === null || Math.abs(lastY - item.transform[5]) > 6) {
                        if (currentP) textLayer.appendChild(currentP);
                        currentP = document.createElement('p');
                    }
                    
                    const span = document.createElement('span');
                    span.textContent = item.str + ' ';
                    currentP.appendChild(span);
                    
                    lastY = item.transform[5];
                });
                if (currentP) textLayer.appendChild(currentP);
                
                // UI Updates
                pageInfo.textContent = `Page ${num} of ${pdfDoc.numPages}`;
                pageInfoContainer.style.display = 'flex';
                applyFontScale();
                updateNavState();
                updateBookmarkButton();
                
                // Re-highlight if there's an active search query
                if (currentSearchQuery) {
                    highlightText(currentSearchQuery);
                }
                
                // Scroll to top
                pdfContainer.scrollTop = 0;
                
            } catch (err) {
                console.error(err);
                textLayer.innerHTML = `<p>Error rendering page ${num}</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        async function performSearch() {
            if (!pdfDoc) return;
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;
            
            currentSearchQuery = query;
            searchResults.innerHTML = '';
            searchStatus.textContent = 'Scanning...';
            
            let matchCount = 0;
            const searchBtn = document.getElementById('search-btn');
            searchBtn.disabled = true;
            
            try {
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    searchStatus.textContent = `Scanning page ${i}/${pdfDoc.numPages}...`;
                    await new Promise(r => setTimeout(r, 0));
                    
                    const matches = await getPageMatches(i, query);
                    matches.forEach(match => {
                        matchCount++;
                        addSearchResult(match);
                    });
                }
                
                searchStatus.textContent = matchCount > 0 
                    ? `Found ${matchCount} matches.` 
                    : 'Not found.';
                
                highlightText(query);
                
            } catch (e) {
                console.error(e);
                searchStatus.textContent = 'Error during search.';
            } finally {
                searchBtn.disabled = false;
            }
        }
        
        async function getPageMatches(pageNum, query) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const content = await page.getTextContent();
                const text = content.items.map(i => i.str).join(' ');
                const lowerText = text.toLowerCase();
                const lowerQuery = query.toLowerCase();
                
                const matches = [];
                let pos = lowerText.indexOf(lowerQuery);
                
                while (pos !== -1) {
                    // Extract snippet: ~20 chars before and after
                    const start = Math.max(0, pos - 20);
                    const end = Math.min(text.length, pos + query.length + 20);
                    let snippet = text.substring(start, end);
                    
                    // Add ellipses if truncated
                    if (start > 0) snippet = '...' + snippet;
                    if (end < text.length) snippet = snippet + '...';
                    
                    matches.push({
                        pageNum,
                        snippet,
                        query
                    });
                    
                    pos = lowerText.indexOf(lowerQuery, pos + 1);
                    if (matches.length >= 20) break; // Limit per page to keep menu performant
                }
                return matches;
            } catch (e) {
                console.error(`Error scanning page ${pageNum}`, e);
                return [];
            }
        }
        
        function addSearchResult(match) {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.style.padding = '6px 8px';
            item.style.borderBottom = '1px solid #eee';
            item.style.cursor = 'pointer';
            item.style.transition = 'background 0.2s';
            
            const safeQuery = match.query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeQuery})`, 'gi');
            const highlightedSnippet = match.snippet.replace(regex, '<mark style="background:#f1c40f; padding:0 1px; border-radius:2px;">$1</mark>');
            
            item.innerHTML = `
                <div style="font-weight:bold; color:#2c3e50; font-size:11px; margin-bottom:2px;">Page ${match.pageNum}</div>
                <div style="font-size:12px; color:#555; line-height:1.3;">${highlightedSnippet}</div>
            `;
            
            item.addEventListener('click', () => {
                goToPageAndHighlight(match.pageNum, match.query);
            });
            
            item.onmouseover = () => item.style.backgroundColor = '#f8f9fa';
            item.onmouseout = () => item.style.backgroundColor = 'transparent';
            
            searchResults.appendChild(item);
        }
        
        async function goToPageAndHighlight(pageNum, query) {
            currentPage = pageNum;
            toggleMenu(false);
            await renderPage(currentPage);
            
            // Allow a small delay for DOM rendering
            setTimeout(() => {
                const highlights = textLayer.querySelectorAll('.highlight');
                if (highlights.length > 0) {
                    // Find the first highlight that matches our query context if possible, 
                    // or just the first one on the page.
                    highlights[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        // Remove old pageContainsText as it is replaced by getPageMatches
        
        function highlightText(query) {
            if (!query) return;
            const spans = textLayer.querySelectorAll('span');
            let found = false;
            // Escape regex special characters
            const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeQuery})`, 'gi');
            
            spans.forEach(span => {
                if (span.textContent.match(regex)) {
                    found = true;
                    span.innerHTML = span.textContent.replace(regex, '<span class="highlight">$1</span>');
                }
            });
            return found;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        }
        
        function nextPage() {
            if (pdfDoc && currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        }
        
        function updateNavState() {
            if (!pdfDoc) {
                navPrev.classList.add('disabled');
                navNext.classList.add('disabled');
                return;
            }
            
            if (currentPage <= 1) navPrev.classList.add('disabled');
            else navPrev.classList.remove('disabled');
            
            if (currentPage >= pdfDoc.numPages) navNext.classList.add('disabled');
            else navNext.classList.remove('disabled');
        }
        
        function adjustFontSize(delta) {
            fontScale = Math.max(MIN_FONT_SCALE, Math.min(fontScale + delta, MAX_FONT_SCALE));
            applyFontScale();
        }
        
        function applyFontScale() {
            textLayer.style.fontSize = `${16 * fontScale}px`;
        }
        
        function setupPinchZoom() {
            let initialDist = 0;
            let initialScale = 1;
            
            pdfContainer.addEventListener('touchstart', e => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialScale = fontScale;
                }
            }, {passive: false});
            
            pdfContainer.addEventListener('touchmove', e => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const ratio = dist / initialDist;
                    fontScale = Math.max(MIN_FONT_SCALE, Math.min(initialScale * ratio, MAX_FONT_SCALE));
                    applyFontScale();
                }
            }, {passive: false});
        }
    </script>
</body>
</html>
